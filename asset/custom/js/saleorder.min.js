var count_enter_form_input_product=0;var count_list=0;var payment_enter=0;var payment_list=0;$(document).ready(function(){$("input.number").keyup(function(b){if(b.which>=37&&b.which<=40){b.preventDefault()}var d=$(this);var a=d.val().replace(/,/gi,"").split("").reverse().join("");var c=RemoveRougeChar(a.replace(/(.{3})/g,"$1,").split("").reverse().join(""));console.log(c);d.val(c)})});function RemoveRougeChar(a){if(a.substring(0,1)==","){return a.substring(1,a.length)}return a}$("#barcode").focus();$("#it_quantity").keypress(function(a){a.preventDefault()});$("#barcode").keyup(function(a){if(a.keyCode==13){var b=$.trim($(this).val());if(b!=""){check_barcode(b)}$(this).val("")}});$("#staffCode").keyup(function(b){if(b.keyCode==13){var a=$.trim($(this).val());if(a!=""){check_sale_person(a)}}});$("#cusTelephone_view").keyup(function(b){if(b.keyCode==13){var a=$.trim($(this).val());if(a!=""){check_customer(a)}}});$("#valueDCTopup").keyup(function(a){if(a.keyCode==13){if($("#valueDCTopup").val()!=""){document.getElementById("dc_topup").innerHTML=parseFloat($("#valueDCTopup").val()).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");$("#hiddenDCTopup").val($("#valueDCTopup").val())}$("#valueDCTopup").val("");$("#modDCTopup").modal("toggle");setTimeout(function(){calculate()},300)}});$("#valueAllPercent").keyup(function(c){if(c.keyCode==13){var a=document.getElementsByName("it_dc_percent");if($("#valueAllPercent").val()!=""){for(var b=0;b<a.length;b++){a[b].value=$("#valueAllPercent").val()}}$("#valueAllPercent").val("");$("#modAllPercent").modal("toggle");setTimeout(function(){calculate()},300)}});$("#paymentValue").keyup(function(d){if(d.keyCode==13){if($("#paymentValue").val()==""){alert("กรุณาใส่ จำนวนเงินที่ชำระ !");$("#paymentValue").focus()}else{$("#btnConfirmPayment").prop("disabled",true);var c=$("#paymentWay").val();var b=($("#paymentValue").val()).replace(/,/g,"");var a='<tr id="row_payment'+payment_enter+'"><td><button type="button" id="row'+payment_enter+'" class="btn btn-danger btn-xs" onClick="delete_payment_row('+payment_enter+');"><i class="fa fa-close"></i></button></td><td><input type="hidden" name="payment_gateway" value="'+c+'">'+c+'</td><td><input type="hidden" name="payment_value" value="'+b+'">'+parseFloat(b).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" บาท</td></tr>";$("#payment_list > tbody").append(a);payment_enter++;payment_list++;$("#btnConfirmPayment").prop("disabled",false);$("#paymentValue").val("");$("#modPayment").modal("toggle");setTimeout(function(){calculate()},300)}}});$("#modAllPercent").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()});$("#modDCTopup").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()});$("#modNewCustomer").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()});$("#modPayment").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()});$("#modSearchPayment").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()});$(document).ready(function(){$("#btnConfirmDCTopup").click(function(){if($("#valueDCTopup").val()!=""){document.getElementById("dc_topup").innerHTML=parseFloat($("#valueDCTopup").val()).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");$("#hiddenDCTopup").val($("#valueDCTopup").val())}$("#valueDCTopup").val("");$("#modDCTopup").modal("toggle");setTimeout(function(){calculate()},300)});$("#btnConfirmAllPercent").click(function(){var a=document.getElementsByName("it_dc_percent");if($("#valueAllPercent").val()!=""){for(var b=0;b<a.length;b++){a[b].value=$("#valueAllPercent").val()}}$("#valueAllPercent").val("");$("#modAllPercent").modal("toggle");setTimeout(function(){calculate()},300)});$("#btnSelectProductType").click(function(){var a="ต้องการให้ข้อมูลทั้งหมดในหน้านี้ ถูกลบใช่หรือไม่ !";return confirm(a)});$("#btnSaveCustomer").click(function(){if($("#cusTelephone").val()==""){alert("กรุณาใส่ เบอร์ติดต่อลูกค้า !");$("#cusTelephone").focus()}else{if($("#cusName").val()==""){alert("กรุณาใส่ ชื่อ-นามสกุลลูกค้า !");$("#cusName").focus()}else{$("#btnSaveCustomer").prop("disabled",true);$.ajax({type:"POST",url:link_new_customer,data:{name:$("#cusName").val(),address:$("#cusAddress").val(),province:$("#cusProvince").val(),telephone:$("#cusTelephone").val(),taxid:$("#cusTaxID").val()},success:function(b){if(b){alert("ทำการบันทึกข้อมูลลูกค้าเรียบร้อยแล้ว !");$("#cusName_view").val($("#cusName").val());var a=" ";if($("#cusProvince").val()!="กรุงเทพมหานคร"){a=" จ."}$("#cusAddress_view").val($("#cusAddress").val()+a+$("#cusProvince").val());$("#cusTaxID_view").val($("#cusTaxID").val());$("#cusTelephone_view").val($("#cusTelephone").val());$("#cusTelephone").val("");$("#cusName").val("");$("#cusAddress").val("");$("#cusTaxID").val("");$("#btnSaveCustomer").attr("disabled",false);$("#modNewCustomer").modal("toggle")}else{alert("ไม่สามารถ บันทึกข้อมูลลูกค้าได้ !")}},error:function(b,a){alert("เกิดความผิดพลาด !!!");$("#btnSaveCustomer").attr("disabled",false)}})}}});$("#btnPayment").click(function(){if($("#var_allcount").val()<1){alert("กรุณา สแกนบาร์โค้ด เพื่อเลือกสินค้า");$("#barcode").focus();return false}else{if($("#saleperson_id").val()<1){alert("กรุณาใส่ รหัสพนักงานขาย !");$("#staffCode").focus();return false}else{var d=0,e=0;var b=document.getElementsByName("it_srp");var j=document.getElementsByName("it_quantity");var h=document.getElementsByName("it_discount");var g=document.getElementsByName("it_net");var c=document.getElementsByName("it_dc_percent");var f=$("#hiddenDCTopup").val();for(var a=0;a<j.length;a++){d+=parseFloat(j[a].value);e+=parseFloat(j[a].value)*parseFloat(b[a].value)-parseFloat((h[a].value).replace(/,/g,""))}e-=f;document.getElementById("totalPrice").value=e.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" บาท";document.getElementById("totalCount").value=d.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}});$("#btnConfirmPayment").click(function(){if($("#paymentValue").val()==""){alert("กรุณาใส่ จำนวนเงินที่ชำระ !");$("#paymentValue").focus()}else{$("#btnConfirmPayment").prop("disabled",true);var c=$("#paymentWay").val();var b=($("#paymentValue").val()).replace(/,/g,"");var a='<tr id="row_payment'+payment_enter+'"><td><button type="button" id="row'+payment_enter+'" class="btn btn-danger btn-xs" onClick="delete_payment_row('+payment_enter+');"><i class="fa fa-close"></i></button></td><td><input type="hidden" name="payment_gateway" value="'+c+'">'+c+'</td><td><input type="hidden" name="payment_value" value="'+b+'">'+parseFloat(b).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" บาท</td></tr>";$("#payment_list > tbody").append(a);payment_enter++;payment_list++;$("#btnConfirmPayment").prop("disabled",false);$("#paymentValue").val("");$("#modPayment").modal("toggle");setTimeout(function(){calculate()},300)}});$("#btnComplete").click(function(){var m="ต้องการปิดการขาย ใช่หรือไม่ !";if(!confirm(m)){return false}else{$("#btnComplete").prop("disabled",true);var t=document.getElementsByName("it_id");var b=document.getElementsByName("stob_id");var x=document.getElementsByName("it_barcode");var f=document.getElementsByName("old_qty");var h=document.getElementsByName("serial_id");var a=document.getElementsByName("it_srp");var k=document.getElementsByName("it_quantity");var z=document.getElementsByName("it_discount");var w=document.getElementsByName("it_net");var o=document.getElementsByName("it_dc_percent");var s=$("#hiddenDCTopup").val();var c=document.getElementsByName("payment_gateway");var q=document.getElementsByName("payment_value");var p=new Array();var y=new Array();var A=new Array();var r=0;var l=0;var n=0;var d=0;var e=0;if(serial==0){for(var v=0;v<t.length;v++){for(var u=0;u<d;u++){if(t[v].value==y[u]["id"]){y[u]["qty"]=parseInt(y[u]["qty"])+parseInt(k[v].value);if(y[u]["qty"]>y[u]["old_qty"]){alert("จำนวนสินค้าคงเหลือไม่เพียงพอกับที่ต้องการ !!");return}e++}}if(e==0){y[d]={id:t[v].value,qty:k[v].value,old_qty:f[v].value};d++}else{e=0}}}else{for(var v=0;v<h.length;v++){for(var u=v+1;u<h.length;u++){if(h[v].value==h[u].value){alert("Serial Number ซ้ำกัน !!");return}}}}for(var v=0;v<t.length;v++){r+=parseFloat((w[v].value).replace(/,/g,""));l+=parseFloat((z[v].value).replace(/,/g,""));p[v]={id:t[v].value,stob_id:b[v].value,barcode:x[v].value,serial_id:h[v].value,srp:(a[v].value).replace(/,/g,""),qty:k[v].value,dc_baht:(z[v].value).replace(/,/g,""),dc_percent:o[v].value,net:(w[v].value).replace(/,/g,""),}}n=(r-s)*0.07/1.07;var g={paymentRemark:$("#paymentRemark").val(),customer_id:$("#customer_id").val(),saleperson_id:$("#saleperson_id").val(),dc_topup:s,total_net:r,total_dc:l,total_tax:n,};for(var v=0;v<c.length;v++){A[v]={paid_gateway:c[v].value,paid_price_paid:q[v].value,}}$.ajax({type:"POST",url:link_save_payment,data:{item:p,payment:g,paid:A,serial:serial},success:function(i){if(i>0){alert("ทำการบันทึกข้อมูลเรียบร้อยแล้ว !");$("#btnComplete").attr("disabled",false);window.location=link_view_payment+"/"+i}else{alert("ไม่สามารถ บันทึกข้อมูลได้ !")}},error:function(j,i){alert("เกิดความผิดพลาด !!!");$("#btnComplete").attr("disabled",false)}})}})});function check_barcode(a){if(a!=""){$.ajax({type:"POST",url:link_check,data:{barcode:a,shop_id:shop_id,serial:serial},success:function(c){if(c!=""){var b='<tr id="row'+count_enter_form_input_product+'"><td><button type="button" id="row'+count_enter_form_input_product+'" class="btn btn-danger btn-xs" onClick="delete_item_row('+count_enter_form_input_product+');"><i class="fa fa-close"></i></button></td>'+c+"</tr>";$("#itemlist > tbody").append(b);count_enter_form_input_product++;count_list++;setTimeout(function(){calculate()},300)}else{if(serial==0){alert("ไม่พบ Ref. Number ที่ต้องการ")}else{alert("ไม่พบ Serial Number ที่ต้องการ")}}},error:function(c,b){alert("เกิดความผิดพลาด !!!")}})}}function check_sale_person(a){if(a!=""){$.ajax({type:"POST",url:link_saleperson,data:{number:a},dataType:"json",success:function(b){if(b.nggu_id>0){$("#saleperson_id").val(b.nggu_id);$("#staffName").val(b.nggu_name);$("#staffCode").val(b.nggu_number)}else{alert("ไม่พบ รหัสพนักงาน ที่ต้องการ");$("#saleperson_id").val("0");$("#staffName").val("");$("#staffCode").val("")}},error:function(c,b){alert("ไม่พบ รหัสพนักงาน ที่ต้องการ !!!");$("#saleperson_id").val("0");$("#staffName").val("");$("#staffCode").val("")}})}}function check_customer(a){if(a!=""){$.ajax({type:"POST",url:link_customer,data:{telephone:a},dataType:"json",success:function(b){if(b.posc_id>0){$("#customer_id").val(b.posc_id);$("#cusName_view").val(b.posc_name);$("#cusAddress_view").val(b.posc_address);$("#cusTaxID_view").val(b.posc_taxid)}else{alert("ไม่พบ ข้อมูลลูกค้า ที่ต้องการ");$("#customer_id").val("0");$("#cusTelephone_view").val("");$("#cusName_view").val("");$("#cusAddress_view").val("");$("#cusTaxID_view").val("")}},error:function(c,b){alert("ไม่พบ ข้อมูลลูกค้า ที่ต้องการ !!!");$("#customer_id").val("0");$("#cusTelephone_view").val("");$("#cusName_view").val("");$("#cusAddress_view").val("");$("#cusTaxID_view").val("")}})}}function calculate(){var g=0,h=0,l=0,a=0,j=0,e=0,k=0;var d=document.getElementsByName("it_srp");var p=document.getElementsByName("it_quantity");var o=document.getElementsByName("it_discount");var n=document.getElementsByName("it_net");var f=document.getElementsByName("it_dc_percent");var m=$("#hiddenDCTopup").val();var b=document.getElementsByName("payment_value");for(var c=0;c<b.length;c++){k+=parseFloat(b[c].value)}for(var c=0;c<p.length;c++){if(o[c].value==""){o[c].value=0}if(p[c].value==""){p[c].value=0}if(f[c].value==""){f[c].value=0}if(f[c].value<0){f[c].value=0}else{if(f[c].value>100){f[c].value=100}}g+=parseFloat(p[c].value);l+=parseFloat(p[c].value)*parseFloat(d[c].value);j=parseFloat(p[c].value)*parseFloat(d[c].value)*((f[c].value)/100);if(j>0){o[c].value=j.toFixed(2)}else{o[c].value=parseFloat(o[c].value).toFixed(2)}a+=parseFloat((o[c].value).replace(/,/g,""));h+=parseFloat(p[c].value)*parseFloat(d[c].value)-parseFloat((o[c].value).replace(/,/g,""));n[c].value=(parseFloat(p[c].value)*parseFloat(d[c].value)-parseFloat((o[c].value).replace(/,/g,""))).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}h-=m;e=h-k;document.getElementById("summary").innerHTML=h.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" บาท";document.getElementById("payment_remain").innerHTML=e.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" บาท";document.getElementById("allcount").innerHTML=g.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");document.getElementById("sum_srp").innerHTML=l.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");document.getElementById("sum_dc").innerHTML=a.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");$("#var_allcount").val(g);if(h>0&&e<=0){$("#btnPayment").addClass("hidden-button");$("#btnComplete").removeClass("hidden-button")}else{$("#btnComplete").addClass("hidden-button");$("#btnPayment").removeClass("hidden-button")}}function delete_item_row(a){count_list--;$("#row"+a).remove();setTimeout(function(){calculate()},300)}function delete_payment_row(a){payment_list--;$("#row_payment"+a).remove();setTimeout(function(){calculate()},300)}function numberWithCommas(c){var a=$(c).val();var b=a.toString().split(".");b[0]=b[0].replace(/,/g,"");b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");$(c).val(b.join("."))};